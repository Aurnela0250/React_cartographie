<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentification Google - Callback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f8f9fa;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Authentification en cours...</h2>
        <p>Veuillez patienter pendant que nous finalisons votre connexion.</p>
    </div>

    <script>
        // Fonction pour extraire les paramètres de l'URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const result = {};
            for (const [key, value] of params) {
                result[key] = value;
            }
            return result;
        }

        // Fonction pour envoyer les données à la fenêtre parent
        function sendAuthResult(data, isError = false) {
            if (window.opener) {
                const message = {
                    type: isError ? 'GOOGLE_AUTH_ERROR' : 'GOOGLE_AUTH_SUCCESS',
                    payload: data,
                    error: isError ? data : null
                };
                
                window.opener.postMessage(message, window.location.origin);
                window.close();
            }
        }

        // Déterminer la base API (backend)
        function resolveApiBase() {
            const params = new URLSearchParams(window.location.search);
            const fromParam = params.get('apiBase');
            if (fromParam) return fromParam;
            if (document.referrer) {
                try {
                    return new URL(document.referrer).origin;
                } catch (_) { /* ignore */ }
            }
            return 'http://localhost:8000';
        }

        // Vérifier si nous sommes sur la page de callback
        if (window.location.pathname.includes('/google-auth-callback') || 
            window.location.search.includes('code=') || 
            window.location.search.includes('error=')) {
            
            const params = getUrlParams();
            const apiBase = resolveApiBase();
            
            if (params.error) {
                // Erreur d'authentification
                sendAuthResult(params.error_description || params.error, true);
            } else if (params.code) {
                // Code d'autorisation reçu, faire une requête pour échanger contre les tokens
                fetch(apiBase + '/api/v1/auth/callback/google-json' + window.location.search, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Succès - envoyer les données à la fenêtre parent
                    sendAuthResult(data, false);
                })
                .catch(error => {
                    console.error('Erreur lors de l\'échange du code:', error);
                    sendAuthResult('Erreur lors de l\'authentification', true);
                });
            } else {
                // Aucun paramètre reconnu
                sendAuthResult('Paramètres d\'authentification manquants', true);
            }
        }

        // Fermer automatiquement après 30 secondes si rien ne se passe
        setTimeout(() => {
            if (window.opener) {
                sendAuthResult('Timeout d\'authentification', true);
            }
        }, 30000);
    </script>
</body>
</html>
